# Simple configuration for an HTTP proxy listening on port 80 on all
# interfaces and forwarding requests to a single backend "servers" with a
# single server "server1" listening on 127.0.0.1:8000

global
    daemon
    maxconn 256
    pidfile <%= pidfile %>

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option http-server-close
    option redispatch

frontend http-in
    bind *:80
    <% servicenames.each do |name| %>
    acl <%= name %>-route path_beg /api/<%= name %>/
    use_backend <%= name %> if <%= name %>-route
    <% end -%>
    <% servicenames.each do |name| %>
    acl <%= name %>-host hdr(host) <%= name %>.dev
    use_backend <%= name %> if <%= name %>-host
    <% end %>

<% servicenames.each do |name| %>
backend <%= name %>
    reqirep ^Host:\ (\S+).*$ Host:\ <%= name %>\r\nX-Forwarded-Host:\ \1
    server name 127.0.0.1:<%= server_port %> maxconn 32
<% end %>