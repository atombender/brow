#!/usr/bin/ruby

require 'rubygems'
require 'thor'
require 'brow'

module Brow
  class CLI < Thor
    include Thor::Actions
    default_task :help    

    map '-r' => 'restart'
    map 'status' => 'list'
    map 'raise' => 'up'
    map 'frowm' => 'down'

    desc "up", "Launch services"
    def up
      wrangler.up
    end

    desc "down", "Shut down services"
    def down
      wrangler.down
    end

    desc "restart [service] [--hard]", "Restart a single service or toggle the whole enchilada"
    method_options :hard => :boolean, :alias => :string
    def restart(name = nil)
      if name
        wrangler.restart(name, options['hard'])
      else
        if options['hard']
          wrangler.down
          wrangler.up
        else
          wrangler.restart_all
        end
      end
    end

    desc "list", "Show status for all configured services"
    def list
      running = wrangler.app_manager.running 
      wrangler.app_manager.application_names.each do |name|
        say "  #{name} #{running.include?(name) ? '(up)' : '(down)'}"
      end
      say "  nginx #{wrangler.proxy.running? ? '(up)' : '(down)'}"
    end

    desc "exec COMMAND", "Execute a shell command in all mounted apps and pebbles"
    method_options :command => :array
    def exec(*command)
      command = command.join(' ')
      wrangler.app_manager.application_dirs.each do |dir|
        puts "#{dir}$ #{command}"
        Brow::ShellEnvironment.exec("#{command} 1>&2", dir)
        puts
      end
    end

    desc "watch", "Watch all mounted apps for changes and reloading on demand"
    def watch
      wrangler.watch
    end

    desc "tail", "Tail the stderr-logs of all services"
    def tail
      `tail -f /tmp/brow-*.stderr.log 1>&2`
    end

    private

    def wrangler
      unless @wrangler
        @wrangler = Brow::Wrangler.new
        @wrangler.ensure_brow_folders
      end
      @wrangler
    end

  end
end
Brow::CLI.start